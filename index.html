<!DOCTYPE html>

<head>
<meta charset="utf-8">


</head>

<body onload="setup()">
<script src="libs/parametric-svg.js" ></script>

<script src="https://d3js.org/d3.v4.min.js" ></script>

<script>




var parameters = {'x': 60, "y": 60, "d": 5};

function importSVG(){

  // clear element list
  var elements = d3.select("#elements");
  elements.node().innerHTML = "";
  var element_list = elements.append("ul");

  parameters = {};

  var svgText = prompt();
  if (!svgText){ return; }

  var svg = document.querySelector('svg');
  svg.innerHTML = svgText;

  var children = svg.childNodes;
  for (var i=0; i<children.length; i++){
    var child = children[i];
    // TODO: need to igo deeper for <g>
    // child.id
    // child.classList
    // child.attributes

    getParameters(child.attributes);

    if (child.tagName){
          var tag_item = element_list.append("li").text(child.tagName);
          var sublist = tag_item.append("ul");


          if (!child.attributes){ continue; }

          for (var j=0; j<child.attributes.length; j++){
            var attribute = child.attributes[j];

            // if (!attribute.name.startsWith("parametric:") &&   attribute.name.substr("11")  ){

            var subitem = sublist.append("li").text(attribute.name + ": ");

            subitem.append("input")
            .property("value", attribute.nodeValue)
            .datum({element: child, attribute_name: attribute.name, attribute: attribute})
            .on("change", function(d){
              d.attribute.value = this.value;
              if (!attribute.name.startsWith("parametric:")){
                applyParameters();
              }
            })

          }


    }

  }



  // Populate parameter list
  var codePanel = d3.select("#parameter-list");

  codePanel.node().innerHTML = "";

  var paramList = codePanel.append("ul");

  for (p in parameters){

  paramList.append("li")
     .text(p + ": ")

     .append("input")
     .attr("id", "parameter-" + p)
     .property("value", parameters[p])
     .datum(p)
     .on("change", function(d){ 
          parameters[d] = +this.value; 
          applyParameters();
    });
  }


}


function getParameters(attributes){

  if (!attributes){ return; }

  for (var j=0; j<attributes.length; j++){
    var attribute = attributes[j];

    if (attribute.name.startsWith("parametric:")){
          var expression = attribute.nodeValue
                    .replace(/\$\{/g, '')
                    .replace(/\}/g, '')
                    .replace(/\+/g, ' ')
                     .replace(/\-/g, ' ')
                     .replace(/\^/g, ' ')
                     .replace(/\//g, ' ')
                     .replace(/\*/g, ' ');
          
          var variables = [];
          var terms = expression.split(" ");

          for (var term in terms){
            console.log(expression + ": " + terms[term]);

            if (!expression[term]){ return; }

            parameters[ terms[term] ] = 0;
          }

    }

  }
}



function applyParameters(){
  var parametric_svg = d3.select("parametric-svg").node();

  var svg = d3.select("parametric-svg").select("svg").node();
  parametricSvg(svg, parameters);
}

function setup(){
   
   applyParameters();

  d3.select("#svg-panel")
    .append("button")
    .text("Copy SVG")
    .on("click",  function() {
    prompt(
      'Press [CTRL + C], then [ENTER] to copy the SVG to your clipboard.',
      d3.select("svg").node().innerHTML
    )})


  d3.select("#svg-panel")
    .append("button")
    .text("Import SVG")
    .on("click", importSVG)
}




</script>


<div id="code-panel">

<h3>Parameters</h3>
<div id="parameter-list"></div>

<h3>Elements</h3>
<div id="elements"></div>


</div>

<div id="svg-panel">
    <parametric-svg>
  
  <svg height="100" width="100">
  <circle parametric:cx="x + d" parametric:cy=y r="40" stroke="black" stroke-width="3" fill="blue" />
  <circle parametric:cx=x parametric:cy=y r="40" stroke="black" stroke-width="3" fill="green" />
</svg> 
    </parametric-svg>
</div>

</body>